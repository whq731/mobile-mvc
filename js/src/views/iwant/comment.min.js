define("jquery underscore backbone text!src/tpl/iwant/comments.tpl text!src/tpl/iwant/more-comments.tpl text!src/tpl/iwant/publish-delete-panel.tpl".split(" "),function(a,g,h,k,l,m){return h.View.extend({lock:!1,options:{},pageSize:10,template:g.template(k),events:{"tap .praise":"praise","tap .comment":"comment","tap .enter":"enterShare","tap .reply_comment":"replyComment","click .more":"moreComment",'tap a[onclick="return false;"]':"tapLocation"},tapLocation:function(){event.target.href&&(location.href=
event.target.href)},praise:function(){a(event.target).removeClass("border");if(!this.lock&&this.options.topic_detail_info.canShare){this.lock=!0;var c=this;ajax_request({action:"iwant_set_praise_original",original_id:this.options.topic_detail_info.original_id}).then(function(a){0==a.errorCode&&(a=c.$el.find(".praise_count"),a.text(Number(a.text())+1));c.lock=!1})}},comment:function(){if(this.options.topic_detail_info.canShare){sessionStorage&&sessionStorage.getItem("temp_publish_content")?(a(".publish_content")[0].value=
sessionStorage.getItem("temp_publish_content"),a(".max_input").html(140-sessionStorage.getItem("temp_publish_content").length+"\u5b57")):(a(".publish_content")[0].value="",a(".max_input").html("140\u5b57"));if("iphone"==$_GET.user_client||"ipad"==$_GET.user_client)a(".publish_panel").css("top",window.scrollY+"px").show(),a(".publish_content").off("click").on("click",function(){setTimeout(function(){a(".publish_panel").css("top",window.scrollY+"px")},100)});else if(a(".publish_panel").css("position",
"fixed").show(),document.documentElement.offsetHeight<document.documentElement.clientHeight)a(".publish_content").off("click").on("click",function(){setTimeout(function(){window.scrollTo(0,0)},100)});location.href="#commentActive";window.commentActive=!0;a(".publish_title").text("\u53d1\u8868\u8bc4\u8bba");var c=this;a(".ok").off().on("click",function(){var b=a.trim(a(".publish_content")[0].value);b&&c.publishComment("comment",b)})}},deleteComment:function(c){if(!this.lock){this.lock=!0;var b=this;
ajax_request({action:"iwant_delete_review",review_id:c}).then(function(d){0==d.errorCode?b.$el.find("a[data-review-id='"+c+"']").parent("p").remove():showError("\u5220\u9664\u5931\u8d25");b.lock=!1;a(".delete_panel").hide()})}},replyComment:function(){if(this.options.topic_detail_info.canShare&&"A"!==event.target.tagName){var c=this,b=a(event.target).find("a").eq(0),d=b.html(),e=b.attr("data-from-cust-id");if("true"==b.attr("data-self"))a(".delete_panel").show(),a(".delete_panel .del").off().on("tap",
function(){var a=b.attr("data-review-id");c.deleteComment(a)});else{sessionStorage&&sessionStorage.getItem("temp_publish_content")?(a(".publish_content")[0].value=sessionStorage.getItem("temp_publish_content"),a(".max_input").html(140-sessionStorage.getItem("temp_publish_content").length+"\u5b57")):(a(".publish_content")[0].value="",a(".max_input").html("140\u5b57"));if("iphone"==$_GET.user_client||"ipad"==$_GET.user_client)a(".publish_panel").css("top",window.scrollY+"px").show(),a(".publish_content").off("click").on("click",
function(){setTimeout(function(){a(".publish_panel").css("top",window.scrollY+"px")},100)});else if(a(".publish_panel").css("position","fixed").show(),document.documentElement.offsetHeight<document.documentElement.clientHeight)a(".publish_content").off("click").on("click",function(){setTimeout(function(){window.scrollTo(0,0)},100)});location.href="#commentActive";window.commentActive=!0;a(".publish_title").text("\u56de\u590d\u8bc4\u8bba");a(".publish_panel .ok").off().on("click",function(){var b=
a.trim(a(".publish_content")[0].value);b&&c.publishComment("reply",b,e,d)})}}},enterShare:function(){var c=cfg.share_text_prefix+a(".original_id_"+this.options.topic_detail_info.original_id).find("h2").text();window.location.href="share://icon="+encodeURIComponent(this.options.topic_detail_info.share_image||"")+"&title="+encodeURIComponent(c)+"&link="+encodeURIComponent("http://m.dangdang.com/app_download.html")+"&channel=0"},publishComment:function(a,b,d,e){sessionStorage&&sessionStorage.setItem("temp_publish_content",
b);switch(a){case "comment":if(!this.lock){this.lock=!0;var f=this;ajax_request({action:"iwant_add_review",original_id:this.options.topic_detail_info.original_id,content:b}).then(function(a){0==a.errorCode?(f.addMoreComment({review_list:[{id:a.last_review_id,from_cust_id:a.current_cust_id,from_cust_nickname:a.current_nickname,type:0,content:b,is_self:!0}]},f.$el.find(".detail")),sessionStorage&&sessionStorage.clear(),f.$el.find(".detail").removeClass("empty")):a.errorMsg?showError(a.errorMsg):showError("\u53d1\u9001\u5931\u8d25");
f.lock=!1;96!=a.errorCode&&history.back()})}break;case "reply":this.lock||(this.lock=!0,f=this,ajax_request({action:"iwant_add_review",original_id:this.options.topic_detail_info.original_id,content:b,to_cust_id:d}).then(function(a){0==a.errorCode?(f.addMoreComment({review_list:[{id:a.last_review_id,from_cust_id:a.current_cust_id,from_cust_nickname:a.current_nickname,to_cust_id:d,to_cust_nickname:e,type:1,content:b,is_self:!0}]},f.$el.find(".detail")),sessionStorage&&sessionStorage.clear()):a.errorMsg?
showError(a.errorMsg):showError("\u53d1\u9001\u5931\u8d25");f.lock=!1;96!=a.errorCode&&history.back()}))}},moreComment:function(){var a=this.$el.find(".hide_comments");if(0<a.length)a.show(),a.removeClass("hide_comments");else{var b=this.$el.find(".more"),d=b.attr("data-page");if(!this.lock){this.lock=!0;var e=this;ajax_request({action:"iwant_get_review_list",original_id:this.options.topic_detail_info.original_id,page:d,page_size:this.pageSize}).then(function(a){0==a.errorCode?(d++,b.attr("data-page",
d),e.addMoreComment(a,e.$el.find(".detail"),"more"),a.review_list&&a.review_list.length<e.pageSize&&b.hide()):2==a.errorCode&&b.hide();e.lock=!1})}}},addMoreComment:function(a,b,d){var e=g.template(l)(a);setTimeout(function(){"more"==d?b.append(e):b.prepend(e)},0)},initialize:function(c){this.lock=!1;this.options=c;this.$el=a(c.topic_detail_info.el);this.$el.empty();this.render();this.publishDeletePanelRender()},render:function(){this.$el.html(this.template(this.options))},publishDeletePanelRender:function(){0==
a("#publish_delete_panel").length&&(a("body").append(a(m)),a(".publish_panel .cancel").off().on("click",function(){a(".publish_panel").hide();"iphone"!=$_GET.user_client&&"ipad"!=$_GET.user_client||setTimeout(function(){window.scrollTo(0,window.scrollY+1);window.scrollTo(0,window.scrollY-1)},100);history.back()}),a(".delete_panel .cancel").off().on("tap",function(){a(".delete_panel").hide()}),a(".publish_content").off("input").on("input",function(){var c=this.value.length||0;a(".max_input").html(140-
c+"\u5b57")}),a("#publish_delete_panel")[0].addEventListener("touchmove",function(a){a.preventDefault()},!1),window.commentActive=!1)}})});
