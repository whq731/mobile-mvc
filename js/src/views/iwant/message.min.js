define(["jquery","underscore","backbone","text!src/tpl/iwant/message.tpl","text!src/tpl/iwant/message-detail.tpl"],function(b,d,f,g,e){return f.View.extend({el:"body",template:d.template(g),loading:b(".loading"),page:2,page_size:cfg.page_size,loading_flag:!0,scroll_flag:!0,interval:null,events:{},bindEvent:function(){b(".message").find("li.jump").off("tap").on("tap",function(a){a.stopPropagation();a.preventDefault();a=b(a.target);var c="",c=a.is(".jump")?"#message/"+a.attr("message_id"):a.is(".reply")?
"#me/"+a.attr("to_cust_id"):a.is(".name")?"#me/"+a.attr("cust_id"):a.is(".img")?"#me/"+a.attr("cust_id"):a.is(".img_img")?"#me/"+a.closest(".img").attr("cust_id"):a.is(".topic")?"#message/"+a.attr("topic_id"):a.is(".topic_img")?"#message/"+a.closest(".topic").attr("topic_id"):"#message/"+a.closest(".jump").attr("message_id");window.location.href=c})},loadTemplate:function(){var a=this;a.loading_flag&&(a.loading_flag=!1,ajax_request({action:"iwant_get_message_list",page:1,page_size:a.page_size}).then(function(c){a.loading_flag=
!0;b(".action_loading").hide();if(0==c.errorCode){try{a.render()}catch(h){throw Error({message:"Template error occurred!(message.tpl)"});}b("header .text").html("\u6d88\u606f");b("header .i_header").remove();if(0>=c.message_list.length)a.loading_flag=!1,a.loading.hide(),b(".message").remove(),b("#frame").append("<div class='nocontent'></div>");else if(c.message_list.length<a.page_size){a.loading_flag=!1;a.loading.hide();try{setTimeout(function(){b(".message ul").empty().append(d.template(e)(c))},
300)}catch(f){throw Error({message:"Template error occurred!(message-detail.tpl)"});}}else{try{setTimeout(function(){b(".message ul").empty().append(d.template(e)(c))},300)}catch(g){throw Error({message:"Template error occurred!(message-detail.tpl)"});}c.message_list.length>=a.page_size&&(b("body"),a.scroll_flag=!0,setTimeout(function(){b(window).off("scroll").on("scroll",function(){a.loading_flag&&b(this).scrollTop()+b(this).height()>=b("body").height()&&(a.loading_flag=!1,a.loading.show(),a.scroll_flag||
a.loading.hide(),console.log(a.scroll_flag),ajax_request({action:"iwant_get_message_list",page:a.page,page_size:a.page_size}).then(function(c){a.loading_flag=!0;if(0==c.errorCode){a.page++;a.loading.hide();try{b(".message ul").append(d.template(e)(c))}catch(h){throw Error({message:"Template error occurred!(message-detail.tpl)"});}c.scrollload=!0;c.message_list.length<a.page_size?(a.loading_flag=!1,a.scroll_flag=!1):a.scroll_flag=!0;setTimeout(a.bindEvent,300)}else a.catchError({})}));setTimeout(function(){a.loadImages()},
0)})},300))}setTimeout(a.bindEvent,300);setTimeout(function(){a.loadImages()},0)}else a.catchError({})}).mobiCatch(function(b){a.loading.hide()}))},catchError:function(a){if(!a.message)a.message="\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5";else if(-1!=a.message.indexOf("undefined")||-1!=a.message.indexOf("null"))a.message="\u6570\u636e\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5";this.loading.hide()},loadImages:function(){var a=this;b(".lazy").each(function(){b(window).scrollTop()+
b(window).height()>=b(this).offset().top&&a.images(b(this))})},images:function(a){var b=new Image,d=a.attr("imgsrc");b.onload=function(){!0==b.complete&&(a.attr("src",d),a.removeClass("lazy"),a.removeAttr("imgsrc"))};b.src=d},initialize:function(){this.page=2;this.loading_flag=!0;b(".action_loading").show();b(window).off("scroll");this.loading.hide();this.loadTemplate()},render:function(){pageSlider.slidePage(b(this.template()));b("body").scrollTop(0)}})});
